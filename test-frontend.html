<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 AI 设置持久化</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        input, button {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>测试 AI 设置持久化功能</h1>
    
    <div class="container">
        <h2>1. 用户登录</h2>
        <div class="form-group">
            <label for="email">邮箱:</label>
            <input type="email" id="email" placeholder="test@example.com">
        </div>
        <div class="form-group">
            <label for="password">密码:</label>
            <input type="password" id="password" placeholder="密码">
        </div>
        <button id="loginBtn" onclick="login()">登录</button>
        <div id="loginStatus"></div>
    </div>

    <div class="container">
        <h2>2. AI 设置</h2>
        <div class="form-group">
            <label for="apiKey">API Key:</label>
            <input type="text" id="apiKey" placeholder="输入 API Key">
        </div>
        <div class="form-group">
            <label for="baseUrl">Base URL:</label>
            <input type="text" id="baseUrl" placeholder="https://api.example.com">
        </div>
        <button id="saveBtn" onclick="saveSettings()" disabled>保存设置</button>
        <div id="saveStatus"></div>
    </div>

    <div class="container">
        <h2>3. 操作</h2>
        <button id="loadBtn" onclick="loadSettings()" disabled>加载设置</button>
        <button id="testBtn" onclick="testSettings()" disabled>测试设置</button>
        <div id="actionStatus"></div>
    </div>

    <div class="container">
        <h2>4. 响应</h2>
        <div id="response">等待操作...</div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://sbp-kmva3bloszw0mptn.supabase.opentrust.net';
        const supabaseAnonKey = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiYW5vbiIsInJlZiI6InNicC1rbXZhM2Jsb3N6dzBtcHRuIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NjQyMTc0MjMsImV4cCI6MjA3OTc5MzQyM30.c6GJ75JiIg5MDaev6vZ4NAnDEJtSrt8fZ_xnV5r-ezQ';
        
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
        let accessToken = null;
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateResponse(message) {
            document.getElementById('response').textContent = message;
        }
        
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            updateStatus('loginStatus', '正在登录...', 'info');
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    updateStatus('loginStatus', `登录失败: ${error.message}`, 'error');
                    return;
                }
                
                accessToken = data.session.access_token;
                updateStatus('loginStatus', '登录成功！', 'success');
                updateResponse(`登录成功，用户 ID: ${data.user.id}`);
                
                // 启用其他按钮
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('testBtn').disabled = false;
                
                // 自动加载现有设置
                loadSettings();
            } catch (err) {
                updateStatus('loginStatus', `登录出错: ${err.message}`, 'error');
                updateResponse(`登录出错: ${err.message}`);
            }
        }
        
        async function saveSettings() {
            const apiKey = document.getElementById('apiKey').value;
            const baseUrl = document.getElementById('baseUrl').value;
            
            if (!apiKey || !baseUrl) {
                updateStatus('saveStatus', '请填写所有字段', 'error');
                return;
            }
            
            updateStatus('saveStatus', '正在保存设置...', 'info');
            
            try {
                const response = await fetch('http://localhost:5001/api/user/ai-settings', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: 'openai',
                        api_key: apiKey,
                        base_url: baseUrl,
                        text_model: 'gpt-4',
                        image_model: 'dall-e-3',
                        temperature: 0.7,
                        top_p: 0.9,
                        top_k: 40,
                        max_output_tokens: 4000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    updateStatus('saveStatus', `保存失败: ${error.error}`, 'error');
                    updateResponse(`保存失败: ${JSON.stringify(error, null, 2)}`);
                    return;
                }
                
                updateStatus('saveStatus', '设置保存成功！', 'success');
                updateResponse('设置保存成功！');
            } catch (err) {
                updateStatus('saveStatus', `保存出错: ${err.message}`, 'error');
                updateResponse(`保存出错: ${err.message}`);
            }
        }
        
        async function loadSettings() {
            if (!accessToken) {
                updateStatus('actionStatus', '请先登录', 'error');
                return;
            }
            
            updateStatus('actionStatus', '正在加载设置...', 'info');
            
            try {
                const response = await fetch('http://localhost:5001/api/user/ai-settings', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    updateStatus('actionStatus', `加载失败: ${error.error}`, 'error');
                    updateResponse(`加载失败: ${JSON.stringify(error, null, 2)}`);
                    return;
                }
                
                const data = await response.json();
                updateStatus('actionStatus', '设置加载成功！', 'success');
                updateResponse(`加载的设置:\n${JSON.stringify(data, null, 2)}`);
                
                // 填充表单
                if (data.data) {
                    document.getElementById('apiKey').value = data.data.api_key || '';
                    document.getElementById('baseUrl').value = data.data.base_url || '';
                }
            } catch (err) {
                updateStatus('actionStatus', `加载出错: ${err.message}`, 'error');
                updateResponse(`加载出错: ${err.message}`);
            }
        }
        
        async function testSettings() {
            if (!accessToken) {
                updateStatus('actionStatus', '请先登录', 'error');
                return;
            }
            
            updateStatus('actionStatus', '正在测试连接...', 'info');
            
            try {
                const response = await fetch('http://localhost:5001/api/ai/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: {
                            provider: 'openai',
                            apiKey: document.getElementById('apiKey').value,
                            baseUrl: document.getElementById('baseUrl').value
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    updateStatus('actionStatus', `测试失败: ${error.error || error.message}`, 'error');
                    updateResponse(`测试失败: ${JSON.stringify(error, null, 2)}`);
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    updateStatus('actionStatus', '连接测试成功！', 'success');
                    updateResponse('连接测试成功！API 设置有效。');
                } else {
                    updateStatus('actionStatus', `连接测试失败: ${data.message}`, 'error');
                    updateResponse(`连接测试失败: ${data.message}`);
                }
            } catch (err) {
                updateStatus('actionStatus', `测试出错: ${err.message}`, 'error');
                updateResponse(`测试出错: ${err.message}`);
            }
        }
        
        // 初始化
        updateResponse('准备就绪。请登录以继续。');
    </script>
</body>
</html>